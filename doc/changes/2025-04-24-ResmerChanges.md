---
title: "Virtual Destination Address Implementation"
date: 2025-04-24
---

# Virtual Destination Address Implementation

## Overview

## Changes

### 1. `Ethernet` Class(`include/Ethernet.h`)
**Added public member Ethernet::BROADCAST** It is the physical broadcast mac address (ff.ff.ff.ff.ff.ff)

### Before:
```cpp
...
// Defining MAC address
struct Address {
    std::uint8_t bytes[MAC_SIZE];
};

static const Ethernet::Address NULL_ADDRESS;
...
const Ethernet::Address Ethernet::NULL_ADDRESS = {{0, 0, 0, 0, 0, 0}};
```

### After:
```cpp
...
// Defining MAC address
struct Address {
    std::uint8_t bytes[MAC_SIZE];
};

static const Ethernet::Address NULL_ADDRESS;
static const Ethernet::Address BROADCAST;
...
const Ethernet::Address Ethernet::NULL_ADDRESS = {{0, 0, 0, 0, 0, 0}};
const Ethernet::Address Ethernet::BROADCAST = {{0xff, 0xff, 0xff, 0xff, 0xff, 0xff}};
```

### Benefits
**Avoid redefinition** The physical broadcast mac address is used in SocketEngine::send() to broadcast the message across the network and also in NIC<>::handleSignal when checking the destination stored in the frame. So in order to avoid having to declare a broadcast_mac multiple times it is defined within the Ethernet class

### 2. `SocketEngine` Class(`include/socketEngine.h`)
**Changed sendto destination address** The send method implemented in SocketEngine properly broadcasts the message across the ethernet. It previously sent the message to the machine's phisycal mac address.

### Before
```cpp
addr.sll_halen = Ethernet::MAC_SIZE;
std::memcpy(addr.sll_addr, _mac_adress, Ethernet::MAC_SIZE);

// Make sure protocol field is in network byte order before sending
frame->prot = htons(frame->prot);

int result = sendto(_sock_fd, frame, size, 0, reinterpret_cast<sockaddr*>(&addr), sizeof(addr));
```

### After
```cpp
addr.sll_halen = Ethernet::MAC_SIZE;
std::memcpy(addr.sll_addr, Ethernet::BROADCAST.bytes, Ethernet::MAC_SIZE);

// Make sure protocol field is in network byte order before sending
frame->prot = htons(frame->prot);

int result = sendto(_sock_fd, frame, size, 0, reinterpret_cast<sockaddr*>(&addr), sizeof(addr));
```

### 3. `NIC` Class(`include/nic.h`)
**Checks the destination** NIC<>::handleSignal() now checks the destination address store in Frame before propagating the received message.

### Before
```cpp
// Convert protocol from network to host byte order
frame.prot = ntohs(frame.prot);
// // Filters out messages from itself
if (_address == frame.src) return;
db<SocketEngine>(INF) << "[SocketEngine] received frame: {src = " << Ethernet::mac_to_string(frame.src) << ", dst = " << Ethernet::mac_to_string(frame.dst) << ", prot = " << frame.prot << ", size = " << bytes_received << "}\n";
```

### After:
```cpp
// Convert protocol from network to host byte order
frame.prot = ntohs(frame.prot);
// // Filters out messages from itself or not addressed to it
if (_address == frame.src || frame.dst != _address && frame.dst != Ethernet::BROADCAST) {
    db<SocketEngine>(INF) << "[SocketEngine] Ignoring frame from self or not for this NIC\n";
    return;
}
db<SocketEngine>(INF) << "[SocketEngine] received frame: {src = " << Ethernet::mac_to_string(frame.src) << ", dst = " << Ethernet::mac_to_string(frame.dst) << ", prot = " << frame.prot << ", size = " << bytes_received << "}\n";
```

### 4. `Virtual Destination Address Test` test(`tests/integration_tests/virtual_dst_address_test.cpp`)
**New Test** First version of an integration test that makes use of the virtual dest address.

### 5. `Error/Warning fixes`
**Fixing errors/warnings** When trying to compile the new test errors and warnings were generated by the compiler.

### Error 1:
```cpp
In file included from tests/system_tests/virtual_dst_address_test.cpp:12:
./include/components/ins_component.h:124:1: warning: missing terminating " character
  124 | ";
      | ^
./include/components/ins_component.h:124:1: error: missing terminating " character
  124 | ";
      | ^~
```

### Problem:
```cpp
             if (bytes_sent_bcast > 0) {
                  db<INSComponent>(DEB) << "[" << name() << "] msg " << counter << " broadcast! (" << bytes_sent_bcast << " bytes)\n";
                 if (_log_file.is_open()) {
                     // Could log broadcast sends too, but might be redundant with local send log
                      // _log_file << time_us_system << "," << vehicle()->id() << "," << counter << ",send_broadcast," << _broadcast_address << ",...
";
                      // _log_file.flush();
                 }
             } else if(running()) {
                  db<INSComponent>(ERR) << "[" << name() << "] failed to broadcast msg " << counter << "!\n";
             }
```

### Fix
```cpp
int bytes_sent_bcast = send(_broadcast_address, msg.c_str(), msg.size());
if (bytes_sent_bcast > 0) {
    db<INSComponent>(DEB) << "[" << name() << "] msg " << counter << " broadcast! (" << bytes_sent_bcast << " bytes)\n";
        if (_log_file.is_open()) {
            // Could log broadcast sends too, but might be redundant with local send log
            // _log_file << time_us_system << "," << vehicle()->id() << "," << counter << ",send_broadcast," << _broadcast_address << ",...";
            // _log_file.flush();
        }
    } else if(running()) {
        db<INSComponent>(ERR) << "[" << name() << "] failed to broadcast msg " << counter << "!\n";
    }

```

### Error 2:
```cpp
In file included from tests/system_tests/virtual_dst_address_test.cpp:10:
./include/components/camera_component.h: In constructor ‘CameraComponent::CameraComponent(Vehicle*, const string&, TheProtocol*, TheAddress)’:
./include/components/camera_component.h:40:44: error: ‘using TheAddress = class Protocol<NIC<SocketEngine> >::Address’ {aka ‘class Protocol<NIC<SocketEngine> >::Address’} has no member named ‘mac’
   40 |         _ecu1_address = TheAddress(address.mac(), ECU1_PORT);
      |                                       
```

### Fix:
```cpp
_ecu1_address = TheAddress(address.padrr(), ECU1_PORT);
```

### Other Possible Solutions:
    - Just copy the address instanced passed to the constructor
    - Pass only the virtual mac address to the contructor and let it instanciate the Protocol<>::Address class with whatever port is defined at the file

### Error 3:
```cpp
./include/components/camera_component.h:41:41: error: no match for call to ‘(const string {aka const std::__cxx11::basic_string<char>}) ()’
   41 |         db<CameraComponent>(INF) << name() << " targeting local ECU1 at: " << _ecu1_address << "\n";
      |     
./include/components/camera_component.h:44:60: error: ‘BROADCAST’ is not a member of ‘Ethernet::Address’
   44 |         _broadcast_address = TheAddress(Ethernet::Address::BROADCAST, 0); // Target port 0 for broadcast for simplicity
      |                              
./include/components/camera_component.h:45:42: error: no match for call to ‘(const string {aka const std::__cxx11::basic_string<char>}) ()’
   45 |          db<CameraComponent>(INF) << name() << " targeting broadcast at: " << _broadcast_address << "\n";
      |           
```
**Similar Errors found in other components**

### Fix:
```cpp
// Determine the local address for ECU1
// We assume the base address is the vehicle's MAC and ECU1 gets port ECU1_PORT
_ecu1_address = TheAddress(address.paddr(), ECU1_PORT);
db<CameraComponent>(INF) << name() << " targeting local ECU1 at: " << _ecu1_address << "\n";

// Define the broadcast address
_broadcast_address = TheAddress(Ethernet::BROADCAST, 0); // Target port 0 for broadcast for simplicity
    db<CameraComponent>(INF) << name() << " targeting broadcast at: " << _broadcast_address << "\n";
```
**Name Getter added to Component** std::string Component::name() method was added
**Similar Errors found in other components**

### Error 4:
```cpp
./include/components/camera_component.h:80:38: error: ‘DEB’ was not declared in this scope
   80 |                  db<CameraComponent>(DEB) << "[" << name() << "] msg " << counter << " sent locally! (" << bytes_sent_local << " bytes)\n";
      |                                      ^~~
./include/components/camera_component.h:93:39: error: ‘DEB’ was not declared in this scope
   93 |                   db<CameraComponent>(DEB) << "[" << name() << "] msg " << counter << " broadcast! (" << bytes_sent_bcast << " bytes)\n";
      |        
```

### Fix:
```cpp
db<CameraComponent>(INF) << "[" << name() << "] msg " << counter << " sent locally! (" << bytes_sent_local << " bytes)\n";
```
**Similar Errors found in other components**

### Error 5:
```cpp
In file included from tests/system_tests/virtual_dst_address_test.cpp:10:
./include/components/camera_component.h:6:10: fatal error: INFug.h: No such file or directory
    6 | #include "INFug.h"
      |          ^~~~~~~~~
compilation terminated.
make: *** [<builtin>: tests/system_tests/virtual_dst_address_test] Error 1
```

### Fix:
**TODO - Pending Fix**

### TODO:
    - Develop the test to better demonstrate the correction of the communication using virtual destination addresses
    - Fix pending errors/warnings
    - iface dummy creation error: 
    ```
    /bin/sh: 1: cannot create tests/logs/current_test_iface: Permission denied
    make: *** [Makefile:170: setup_dummy_iface] Error 2
    ```